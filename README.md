# 智能语音播报助手

这是一个微信小程序，提供文本转语音、实时输入播报、音色选择和语音克隆等功能。

## 功能列表

1. **文本转语音**：上传文件（.txt/.docx）生成语音
2. **实时输入播报**：输入文字实时播报
3. **音色选择**：选择和管理不同的音色
4. **语音克隆**：克隆用户声音创建自定义音色

## 页面说明

- **首页**：功能导航界面，包含四个功能入口卡片
- **文本转语音页**：上传文件并转换为语音
- **实时输入播报页**：输入文字实时合成语音
- **音色选择页**：管理预设和自定义音色
- **语音克隆页**：上传录音创建个性化音色
- **用户中心**：用户信息和设置管理

## 项目结构

```
├── app.js                  // 应用入口文件
├── app.json                // 应用配置文件
├── app.wxss                // 应用全局样式
├── assets/                 // 资源文件夹
│   ├── icons/              // 图标资源
├── pages/                  // 页面文件夹
│   ├── index/              // 首页
│   ├── text-to-speech/     // 文本转语音页
│   ├── realtime-speech/    // 实时输入播报页
│   ├── voice-selection/    // 音色选择页
│   ├── voice-clone/        // 语音克隆页
│   └── user-center/        // 用户中心页
├── utils/                  // 工具函数
│   └── util.js             // 通用工具
├── project.config.json     // 项目配置
└── sitemap.json            // 站点地图
```

## 开发说明

1. 请确保已安装微信开发者工具
2. 需要在微信公众平台注册小程序
3. 需要申请使用麦克风权限

## 图标资源

本项目需要替换以下图标资源：

- `/assets/icons/document-sound.png`：文档语音图标
- `/assets/icons/keyboard-mic.png`：键盘麦克风图标
- `/assets/icons/voices.png`：音色选择图标
- `/assets/icons/mic-dna.png`：语音克隆图标

## 注意事项

- 语音克隆功能仅用于合法用途，严禁克隆他人声音或用于非法用途
- 请在使用前确保已获得麦克风权限
- 大文件上传时会启用分片上传，防止卡顿

## 版本信息

- 版本：1.0.0
- 最后更新：2023年10月

## 云开发配置

本项目使用微信小程序云开发功能，在运行前需要进行以下配置：

### 1. 创建云开发环境

1. 登录微信开发者工具
2. 点击"云开发"按钮
3. 创建一个新的云开发环境（如果已有则跳过）

### 2. 配置环境ID

1. 打开`app.js`文件
2. 找到`wx.cloud.init`函数
3. 将`env`参数替换为您自己的云环境ID

```javascript
wx.cloud.init({
  env: '您的云环境ID', // 此处替换
  traceUser: true,
});
```

### 3. 部署云函数

1. 打开项目中的`cloudfunctions`文件夹
2. 右键点击`getXfyunApiKeys`文件夹，选择"上传并部署：云端安装依赖"

### 4. 配置环境变量

1. 进入微信开发者工具的云开发控制台
2. 点击"云函数"
3. 找到`getXfyunApiKeys`函数，点击"配置"
4. 在"环境变量"部分添加以下三个变量：
   - `XFYUN_APPID`: 科大讯飞应用的APPID
   - `XFYUN_API_KEY`: 科大讯飞应用的API KEY
   - `XFYUN_API_SECRET`: 科大讯飞应用的API SECRET

### 5. 创建数据库集合

1. 在云开发控制台，点击"数据库"
2. 创建名为`api_access_logs`的集合，用于记录API访问日志

## 科大讯飞API配置

请参考`xfyun-api-guide.md`文件，了解如何申请和配置科大讯飞API。

## 开发与调试

1. 克隆本仓库
2. 在微信开发者工具中导入项目
3. 完成上述云开发配置
4. 编译运行

## 注意事项

- 本项目使用的云开发功能需要微信开发者工具基础库版本 2.2.3 或以上
- 使用语音克隆功能需要获取麦克风权限
- API密钥等敏感信息均通过云函数安全存储，请勿在客户端代码中明文存储

## 域名配置说明

### 添加合法域名（生产环境必需）

1. 登录[微信公众平台](https://mp.weixin.qq.com/)
2. 进入【开发】-【开发设置】-【服务器域名】
3. 在【request合法域名】和【WebSocket合法域名】中添加：
   - `tts-api.xfyun.cn`
4. 点击【保存】并等待审核通过

### 开发环境中临时关闭域名检查

在开发阶段，可以在微信开发者工具中临时关闭域名检查：

1. 打开微信开发者工具
2. 点击右上角【详情】
3. 勾选【本地设置】下的【不校验合法域名、web-view（业务域名）、TLS版本以及HTTPS证书】
4. 重启项目

> ⚠️ 注意：关闭域名检查仅适用于开发环境，小程序上线前必须配置正确的合法域名。

## 使用说明

1. 确保已开通科大讯飞语音合成服务
2. 在云函数中配置正确的APPID、API KEY和API SECRET
3. 编译并运行小程序

## 常见问题

### WebSocket错误: url not in domain list

**问题原因**：尝试连接的WebSocket URL不在小程序的合法域名列表中。

**解决方法**：
1. 开发环境：在微信开发者工具中关闭域名检查
2. 生产环境：在微信公众平台添加`tts-api.xfyun.cn`到WebSocket合法域名列表

### 无法播放音频

**问题原因**：可能是音频格式问题或权限问题。

**解决方法**：
1. 确保业务参数中`aue`和`auf`设置正确
2. 检查是否有音频播放权限
3. 查看控制台日志，确认音频数据是否正确接收